<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stronger in 30 ‚Äî Intermediate Board</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root {
  --white: #ffffff;
  --off: #f7f6f3;
  --bg: #fafaf8;
  --ink: #1a1a1a;
  --ink-muted: #8a8a8a;
  --ink-light: #c8c8c8;
  --accent: #1d4ed8;
  --accent-light: #eff6ff;
  --accent-mid: #2563eb;
  --border: #e8e6e0;
  --border-strong: #d0cec8;
  --gold: #e2b500;
  --gold-bg: #fdf8e8;
  --purple-soft: #ede9fe;
  /* Use a single subtle accent for week highlights to avoid too many conflicting colors */
  --wk-accent: #1d4ed8;
  --radius: 10px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.07), 0 1px 4px rgba(0,0,0,0.04);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--white);
  color: var(--ink);
  font-family: 'Syne', sans-serif;
  -webkit-font-smoothing: antialiased;
  padding: 0;
}

/* ‚îÄ‚îÄ TOP HEADER BAND ‚îÄ‚îÄ */
.masthead {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 36px 48px 28px;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 24px;
}

.masthead-left {}

.studio-tag {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: var(--ink-muted);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.studio-tag::before {
  content: '';
  display: inline-block;
  width: 18px;
  height: 1px;
  background: var(--ink-muted);
}

.title-group {
  display: flex;
  align-items: baseline;
  gap: 16px;
}

.main-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 56px;
  font-weight: 600;
  letter-spacing: -0.02em;
  line-height: 1;
  color: var(--ink);
}

.main-title em {
  font-style: italic;
  color: var(--accent);
}

.level-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--accent-light);
  color: var(--accent);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  padding: 5px 12px;
  border-radius: 100px;
  border: 1px solid rgba(29,78,216,0.15);
  margin-bottom: 6px;
}

.masthead-right {
  text-align: right;
  flex-shrink: 0;
}

.date-range {
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--ink-muted);
  margin-bottom: 6px;
}

.date-range strong {
  color: var(--ink);
  font-weight: 700;
}

.member-count {
  font-size: 28px;
  font-weight: 800;
  color: var(--ink);
  line-height: 1;
}

.member-count span {
  font-size: 11px;
  font-weight: 500;
  color: var(--ink-muted);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-left: 4px;
  vertical-align: middle;
}

.qualified-count {
  font-size: 14px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 0.05em;
  margin-top: 2px;
}

/* ‚îÄ‚îÄ STICKER LEGEND ‚îÄ‚îÄ */
.sticker-legend {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 14px 48px;
  display: flex;
  align-items: center;
  gap: 28px;
  overflow-x: auto;
}

.legend-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--ink-muted);
  white-space: nowrap;
  flex-shrink: 0;
}

.legend-items {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 7px;
  font-size: 11px;
  font-weight: 500;
  color: var(--ink);
  white-space: nowrap;
}

.sticker-preview {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  border-radius: 8px;
  background: var(--off);
  border: 1px solid var(--border);
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ CHALLENGE INFO ‚îÄ‚îÄ */
.challenge-info {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border-bottom: 1px solid #bfdbfe;
  padding: 20px 48px;
}

.challenge-title {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: #1d4ed8;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.challenge-title::before {
  content: 'üéØ';
  font-size: 14px;
}

.challenge-weeks {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-bottom: 12px;
}

.challenge-week {
  display: flex;
  flex-direction: column;
  gap: 5px;
  background: white;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid #bfdbfe;
  box-shadow: 0 1px 3px rgba(29,78,216,0.08);
  transition: all 0.18s ease;
}

.challenge-week:hover {
  border-color: #93c5fd;
  box-shadow: 0 3px 10px rgba(29,78,216,0.15);
  transform: translateY(-1px);
}

.cw-label {
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: white;
  background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
  padding: 3px 9px;
  border-radius: 5px;
  display: inline-block;
  width: fit-content;
  box-shadow: 0 2px 4px rgba(29,78,216,0.25);
}

.cw-goal {
  font-size: 12px;
  font-weight: 600;
  font-family: 'DM Mono', monospace;
  color: var(--ink);
  line-height: 1.4;
  padding-left: 1px;
}

.challenge-note {
  font-size: 10px;
  font-weight: 500;
  color: #1d4ed8;
  background: rgba(29,78,216,0.08);
  padding: 6px 12px;
  border-radius: 5px;
  display: inline-block;
  width: fit-content;
}

/* ‚îÄ‚îÄ MAIN TABLE AREA ‚îÄ‚îÄ */
.board-wrap {
  padding: 32px 48px 48px;
}

.table-scroll {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: var(--shadow-md);
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: max-content;
  table-layout: fixed;
}

/* ‚îÄ‚îÄ WEEK GROUP HEADERS ‚îÄ‚îÄ */
th.week-h {
  background: linear-gradient(to bottom, var(--off) 0%, var(--white) 100%);
  border-bottom: 2px solid var(--border-strong);
  border-left: 2px solid var(--border-strong);
  padding: 0;
  text-align: center;
  vertical-align: middle;
}

th.week-h:first-of-type {
  border-left: none;
}

th.week-h.bonus-week {
  background: linear-gradient(to bottom, #fafafa 0%, var(--white) 100%);
}

th.week-h.bonus-week .week-tag {
  background: #888;
  font-size: 7px;
  padding: 3px 8px;
}

/* Week header completion highlighting */
/* Subtle, single-accent week header when goals are met */
th.week-h.week-goals-met {
  background: rgba(29,78,216,0.06);
  border-color: rgba(29,78,216,0.18);
}
th.week-h.week-goals-met .week-tag {
  background: var(--wk-accent);
  color: white;
  box-shadow: 0 1px 3px rgba(29,78,216,0.15);
}
th.week-h.week-goals-met .week-dates {
  color: rgba(29,78,216,0.9);
  font-weight: 600;
}

th.week-h.bonus-week .week-dates {
  color: #aaa;
}

.week-header-row th {
  padding: 0;
}

.week-group-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  min-height: 44px;
  padding: 8px 6px;
}

.location-label-cell {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--accent);
  white-space: nowrap;
  vertical-align: middle;
}
.location-goal-cell {
  padding: 6px 2px !important;
  vertical-align: middle;
  text-align: center;
}
.loc-goal-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 3px;
  width: 100%;
}
.loc-span-arrow {
  font-size: 16px;
  color: var(--accent);
  opacity: 0.48;
  flex-shrink: 0;
  pointer-events: none;
  line-height: 1;
  width: 14px;
  height: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.loc-goal-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0;
  background: linear-gradient(180deg, #ffffff 0%, var(--accent-light) 100%);
  color: var(--accent);
  border: 1px solid rgba(29,78,216,0.24);
  border-radius: 10px;
  width: 84px;
  min-height: 28px;
  padding: 4px 10px;
  cursor: pointer;
  font-family: inherit;
  transition: border-radius 0.15s, padding 0.15s, box-shadow 0.15s;
  box-shadow: 0 4px 12px rgba(29,78,216,0.16), inset 0 1px 0 rgba(255,255,255,0.7);
  white-space: nowrap;
}
.loc-goal-badge:hover {
  filter: brightness(1.02);
  box-shadow: 0 6px 16px rgba(29,78,216,0.22), inset 0 1px 0 rgba(255,255,255,0.8);
}
.loc-goal-badge.open {
  border-radius: 10px;
  width: min(100%, 220px);
  min-height: 30px;
  padding: 7px 10px;
  align-items: flex-start;
  overflow: hidden;
}
.loc-badge-label {
  font-size: 8px;
  font-weight: 800;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  width: 100%;
  text-align: center;
  pointer-events: none;
}
.loc-badge-detail {
  display: none;
  flex-direction: column;
  align-items: flex-start;
  gap: 5px;
  margin-top: 6px;
  width: 100%;
}
.loc-goal-badge.open .loc-badge-detail { display: flex; }
.loc-req-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  background: linear-gradient(180deg, rgba(29,78,216,0.95) 0%, rgba(30,64,175,0.95) 100%);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 7px;
  padding: 2px 6px;
  width: 100%;
  white-space: normal;
  overflow-wrap: anywhere;
  pointer-events: none;
}
.loc-req-count {
  font-style: normal;
  font-size: 10px;
  font-weight: 800;
  font-family: 'DM Mono', monospace;
  color: rgba(255,255,255,0.75);
  min-width: 16px;
  text-align: right;
}
.loc-req-icon { font-size: 13px; line-height: 1; }
.loc-req-name {
  font-size: 10px;
  font-weight: 600;
  color: #fff;
  letter-spacing: 0.01em;
}

.week-tag {
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: white;
  background: var(--wk-accent, #2d5a27);
  padding: 3px 10px;
  border-radius: 100px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  white-space: nowrap;
}

.week-dates {
  font-size: 8px;
  font-weight: 500;
  color: var(--ink-muted);
  letter-spacing: 0.06em;
  white-space: nowrap;
}

/* ‚îÄ‚îÄ COLUMN HEADERS ‚îÄ‚îÄ */
thead th {
  background: var(--white);
  border-bottom: 2px solid var(--border-strong);
  padding: 5px;
  font-weight: 600;
  vertical-align: bottom;
}

th.rank-h {
  width: 40px;
  min-width: 40px;
}

th.name-h {
  min-width: 175px;
  width: 175px;
  text-align: left;
  padding-left: 8px;
  padding-bottom: 10px;
}

th.name-h .col-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--ink-muted);
}

th.day-h {
  width: 42px;
  min-width: 42px;
  text-align: center;
  padding-bottom: 8px;
  position: relative;
}

th.day-h.weekend .day-num { color: var(--ink-light); }

.day-num {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--ink);
  line-height: 1;
}

.day-name {
  display: block;
  font-size: 8px;
  font-weight: 500;
  color: var(--ink-muted);
  letter-spacing: 0.05em;
  margin-top: 2px;
}

th.score-h {
  width: 64px;
  min-width: 64px;
  text-align: center;
  padding-bottom: 10px;
}

th.score-h .col-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--ink-muted);
}

/* ‚îÄ‚îÄ DATA ROWS ‚îÄ‚îÄ */
tbody tr.data-row {
  border-bottom: 1px solid var(--border);
  transition: background 0.12s;
}

tbody tr.data-row:hover { background: #f9f9f7; }
tbody tr.data-row:last-of-type { border-bottom: none; }

/* rank */
td.rank-td {
  text-align: center;
  width: 40px;
  padding: 0 4px;
  vertical-align: middle;
}

.rank-inner {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  font-size: 11px;
  font-weight: 700;
  margin: 0 auto;
  color: var(--ink-muted);
  background: transparent;
}

.rank-inner.r1 {
  font-size: 18px;
}
.rank-inner.r2 {
  font-size: 18px;
}
.rank-inner.r3 {
  font-size: 18px;
}

/* name */
td.name-td {
  padding: 0 16px 0 8px;
  vertical-align: middle;
  height: 52px;
}

.member-name {
  font-size: 13.5px;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.2;
}

.member-sub {
  font-size: 10px;
  color: var(--ink-muted);
  font-weight: 400;
  margin-top: 1px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.streak-flame {
  display: none;
  align-items: center;
  gap: 2px;
  font-size: 10px;
  font-weight: 700;
  color: #e55b2d;
}
.streak-flame.show { display: flex; }

/* sticker cell */
td.day-td {
  text-align: center;
  vertical-align: middle;
  width: 42px;
  height: 52px;
  padding: 0 2px;
  position: relative;
  overflow: visible;
}

td.day-td.weekend { background: #fafafa; }

td.day-td.week-completed {
  position: relative;
}

td.day-td.week-completed.weekend {
  background: #fafafa;
}

td.day-td.week-completed .sticker-slot.has-sticker {
  /* Subtle completed-week indicator */
  border: 1.5px solid rgba(29,78,216,0.28);
}

/* The sticker slot */
.sticker-slot {
  width: 34px;
  height: 34px;
  margin: 8px auto;
  border-radius: 8px;
  border: 1.5px dashed var(--border-strong);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: default;
  transition: all 0.15s ease;
  position: relative;
  font-size: 20px;
  background: transparent;
  user-select: none;
}

.sticker-slot:hover {
  border-color: var(--accent-mid);
  background: var(--accent-light);
}

.sticker-slot.has-sticker {
  border: none;
  background: var(--off);
  transform: none;
}

.sticker-slot.has-sticker:hover {
  background: #f0ede6;
}

/* Qualifying sticker highlight */
.sticker-slot.qualifying {
  border: 1.5px solid var(--accent-mid);
}
.sticker-slot.has-sticker.qualifying {
  border: 1.5px solid var(--accent-mid);
}
.sticker-slot.qualifying::after {
  content: '‚úì';
  position: absolute;
  top: -8px;
  right: -8px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 900;
  color: #22c55e;
  background: #0a0a0a;
  box-shadow: 0 2px 6px rgba(0,0,0,0.45);
  pointer-events: none;
  z-index: 10;
  line-height: 1;
}

/* Shared JS tooltip */
#cell-tooltip {
  display: none;
  position: fixed;
  z-index: 9999;
  background: var(--ink);
  color: #fff;
  font-family: 'Syne', sans-serif;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.06em;
  white-space: pre-line;
  line-height: 1.45;
  max-width: 260px;
  padding: 7px 9px;
  border-radius: 6px;
  pointer-events: none;
  box-shadow: 0 3px 10px rgba(0,0,0,0.22);
  transform: translateX(-50%);
}



/* score */
td.score-td {
  text-align: center;
  vertical-align: middle;
  width: 64px;
  padding: 0 8px;
  position: relative;
}

.score-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  height: 24px;
  border-radius: 100px;
  font-size: 12px;
  font-weight: 700;
  font-family: 'DM Mono', monospace;
  color: var(--ink-muted);
  background: var(--off);
  cursor: help;
  position: relative;
}

.score-pill.lit {
  background: var(--accent-light);
  color: var(--accent);
}

.score-pill.maxed {
  background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
  color: #a855f7;
  border: 1px solid #e9d5ff;
}

.score-tooltip {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-bottom: 8px;
  background: var(--ink);
  color: white;
  padding: 12px 14px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 500;
  white-space: nowrap;
  z-index: 100;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
}

.score-pill:hover .score-tooltip {
  display: block;
}

.score-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--ink);
}

.weekly-status {
  display: flex;
  gap: 8px;
  align-items: center;
}

.week-badge {
  font-size: 9px;
  font-weight: 700;
  padding: 4px 8px;
  border-radius: 5px;
  background: var(--accent-light);
  border: 1px solid var(--accent);
  color: var(--accent);
  opacity: 0.45;
  min-width: 42px;
  text-align: center;
}

.week-badge.complete {
  background: var(--accent-light);
  color: var(--accent);
  border-color: var(--accent);
  opacity: 1;
  font-weight: 800;
}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
.board-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 48px 40px;
  gap: 20px;
}

.footer-note {
  font-size: 10px;
  color: var(--ink-muted);
  letter-spacing: 0.08em;
}

.footer-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 16px;
  font-style: italic;
  color: var(--ink-light);
  letter-spacing: 0.05em;
}

/* Scrollbar */
.table-scroll::-webkit-scrollbar { height: 4px; }
.table-scroll::-webkit-scrollbar-track { background: var(--off); }
.table-scroll::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 2px; }

/* Responsive */
@media (max-width: 1200px) {
  .challenge-weeks {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .challenge-weeks {
    grid-template-columns: 1fr;
  }

  .masthead {
    flex-direction: column;
    align-items: flex-start;
  }

  .masthead-right {
    text-align: left;
  }
}

/* Animate rows in */
tbody tr.data-row {
  animation: rowIn 0.35s ease both;
}

@keyframes rowIn {
  from { opacity: 0; transform: translateX(-8px); }
  to { opacity: 1; transform: translateX(0); }
}

/* ‚îÄ‚îÄ LOCATION GROUP SEPARATOR ‚îÄ‚îÄ */
tr.location-group-header { animation: none; }
td.location-header-cell {
  padding: 10px 18px 12px;
  background: var(--accent-light);
  border-top: 2px solid var(--border-strong);
  border-bottom: 1px solid var(--border-strong);
}
tr.location-group-header:first-child td.location-header-cell { border-top: none; }

.location-toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  color: var(--accent);
  padding: 0;
  font-family: inherit;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  transition: opacity 0.2s ease;
}

.location-toggle-btn:hover { opacity: 0.7; }

.location-toggle-icon {
  display: inline-block;
  flex-shrink: 0;
  transition: transform 0.2s ease;
  font-size: 12px;
  font-style: normal;
}

.location-toggle-btn.collapsed .location-toggle-icon {
  transform: rotate(-90deg);
}

tr.data-row.hidden { display: none; }
.data-status {
  font-size: 9px;
  font-weight: 500;
  color: var(--ink-muted);
  letter-spacing: 0.06em;
  margin-top: 6px;
  min-height: 14px;
}
.refresh-btn {
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.06em;
  background: var(--off);
  border: 1px solid var(--border-strong);
  border-radius: 5px;
  padding: 3px 10px;
  cursor: pointer;
  color: var(--ink);
  margin-top: 4px;
  transition: background 0.15s;
  font-family: 'Syne', sans-serif;
}
.refresh-btn:hover { background: var(--border); }
.refresh-btn:disabled { opacity: 0.45; cursor: default; }

/* ‚îÄ‚îÄ BOARD LOADER ‚îÄ‚îÄ */
#board-loader {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.85);
  z-index: 200;
  transition: opacity 0.3s;
}
#board-loader.hidden {
  opacity: 0;
  pointer-events: none;
}
.board-spinner {
  width: 36px;
  height: 36px;
  border: 3px solid rgba(0,0,0,0.08);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: loaderSpin 0.7s linear infinite;
}
@keyframes loaderSpin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
  <!-- Dynamic configuration loading -->
  <script>
    // Initialize default config first
    window.GOOGLE_SHEETS_CONFIG = {
      SPREADSHEET_ID: 'YOUR_SPREADSHEET_ID_HERE',
      SHEET_NAME: 'Checkins',
      CLIENT_ID: 'YOUR_CLIENT_ID_HERE',
      CLIENT_SECRET: 'YOUR_CLIENT_SECRET_HERE',
      REFRESH_TOKEN: 'YOUR_REFRESH_TOKEN_HERE'
    };
    
    // Try to load config.live.js if it exists (silent loading)
    const configScript = document.createElement('script');
    configScript.src = 'config.live.js';
    configScript.onerror = function() {
      const loader = document.getElementById('board-loader');
      if (loader) loader.classList.add('hidden');
    };
    configScript.onload = function() {
      console.log('‚úÖ Loaded custom configuration');
      if (typeof fetchAndSeedCheckins === 'function') fetchAndSeedCheckins();
    };
    document.head.appendChild(configScript);
  </script>

<!-- CELL TOOLTIP -->
<div id="cell-tooltip"></div>

<!-- BOARD LOADER -->
<div id="board-loader">
  <div class="board-spinner"></div>
</div>

<!-- MASTHEAD -->
<div class="masthead">
  <div class="masthead-left">
    <div class="level-chip">‚≠ê‚≠ê Intermediate Board</div>
    <div class="title-group">
      <h1 class="main-title">Stronger <em>in 30</em></h1>
    </div>
  </div>
  <div class="masthead-right">
    <div class="date-range"><strong>23 Feb</strong> ‚Äî <strong>24 Mar 2026</strong></div>
    <div class="member-count">
      <div id="member-count-display">48 <span>Members</span></div>
      <div class="qualified-count" id="qualified-count-display">0 Qualified</div>
    </div>
    <div id="data-status" class="data-status"></div>
    <button onclick="fetchAndSeedCheckins()" id="refresh-btn" class="refresh-btn">‚Üª Refresh</button>
  </div>
</div>

<!-- STICKER LEGEND -->
<div class="sticker-legend">
  <div class="legend-label">Class Format</div>
  <div class="legend-items" id="legend-items"></div>
</div>

<!-- BOARD -->
<div class="board-wrap">
  <div class="table-scroll">
    <table id="main-table">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- FOOTER -->
<div class="board-footer">
  <div class="footer-note">Stickers auto-populated from Google Sheets check-ins</div>
  <div class="footer-logo">Physique 57</div>
</div>

<script>
// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
const MEMBERS = [
  // ‚îÄ‚îÄ Kemps Corner ‚îÄ‚îÄ
  { first: "Aishwarya", last: "Kasliwal",      email: "hello@twistmedia.in",                loc: "KC" },
  { first: "Aliasgar",  last: "Nalwala",        email: "ali@asmaco.com",                     loc: "KC" },
  { first: "Amruta",    last: "Patil",          email: "amrutavpatil@gmail.com",             loc: "KC" },
  { first: "Anjie",     last: "Kakar",          email: "anjiekakar@gmail.com",               loc: "KC" },
  { first: "Ankita",    last: "Saigal",         email: "ankitasaigal1997@gmail.com",         loc: "KC" },
  { first: "Anu",       last: "Patel",          email: "anu.patel91@gmail.com",              loc: "KC" },
  { first: "Avni",      last: "Padsala",        email: "avnipadsala@gmail.com",              loc: "KC" },
  { first: "Ayesha",    last: "Munot",          email: "ayesha@physique57mumbai.com",        loc: "KC" },
  { first: "Deniese",   last: "Pereira",        email: "deniesepereira01@gmail.com",         loc: "KC" },
  { first: "Devia",     last: "Cornelius",      email: "devia.cornelius@gmail.com",          loc: "KC" },
  { first: "Dhanshri",  last: "Merchant",       email: "dhanshri.merchant@gmail.com",        loc: "KC" },
  { first: "Dhanushi",  last: "Dhandhukiya",    email: "dhanu.dhandhukiya@gmail.com",        loc: "KC" },
  { first: "Hinal",     last: "Kuvadia",        email: "kuvadia.hinal@gmail.com",            loc: "KC" },
  { first: "Maithili",  last: "Raut",           email: "maithili.raut@gmail.com",            loc: "KC" },
  { first: "Malcolm",   last: "Mistry",         email: "malcolm@ushtate.com",                loc: "KC" },
  { first: "Manvee",    last: "K S",            email: "manvee1999@gmail.com",               loc: "KC" },
  { first: "Miti",      last: "Joshi",          email: "joshimiti08@gmail.com",              loc: "KC" },
  { first: "Neelam",    last: "Ganglani",       email: "neelam.ganglani@gmail.com",          loc: "KC" },
  { first: "Nidhi",     last: "Jain",           email: "nidhij92@gmail.com",                 loc: "KC" },
  { first: "Niharika",  last: "Malik",          email: "niharika@meecuryind.com",            loc: "KC" },
  { first: "Nikita",    last: "Pacheriwal",     email: "ntodi@hotmail.com",                  loc: "KC" },
  { first: "Poonam",    last: "Agarwal",        email: "p_mukim@yahoo.com",                  loc: "KC" },
  { first: "Preeti",    last: "Ambani",         email: "preeti.ambani@gmail.com",            loc: "KC" },
  { first: "Prianca",   last: "Jhaveri",        email: "priancajhaveri@gmail.com",           loc: "KC" },
  { first: "Priyanka",  last: "Chokhani",       email: "priyankaa2787@gmail.com",            loc: "KC" },
  { first: "Raksha",    last: "Bokadiya",       email: "jkbokadia@gmail.com",                loc: "KC" },
  { first: "Riah",      last: "Daswani",        email: "riahdaswani@gmail.com",              loc: "KC" },
  { first: "Saachi",    last: "Shetty",         email: "saachi@physique57india.com",         loc: "KC" },
  { first: "Sanna",     last: "Balsari",        email: "s.linnea7@gmail.com",                loc: "KC" },
  { first: "Saroj",     last: "Javeri",         email: "saroj_821@hotmail.com",              loc: "KC" },
  { first: "Simran",    last: "Shahani",        email: "simran_shahani@icloud.com",          loc: "KC" },
  { first: "Sreejita",  last: "DEB",            email: "debsreejita23@gmail.com",            loc: "KC" },
  { first: "SunainaK",  last: "Kewalramani",    email: "sukewalramani@gmail.com",            loc: "KC" },
  { first: "Swetha",    last: "Jain",           email: "swethajain4@gmail.com",              loc: "KC" },
  { first: "Vidhi",     last: "Kapadia",        email: "vidhi.kapadia1@gmail.com",           loc: "KC" },
  // ‚îÄ‚îÄ Bandra ‚îÄ‚îÄ
  { first: "Anshika",   last: "Agrawal",        email: "anshika.aggy@gmail.com",             loc: "Bandra" },
  { first: "Anushka",   last: "Mehra",          email: "anushka.socialshout@gmail.com",      loc: "Bandra" },
  { first: "Harpreet",  last: "Kaur",           email: "harpreet2391@gmail.com",             loc: "Bandra" },
  { first: "Kanchaan",  last: "Kaicker",        email: "kanchaan1991@gmail.com",             loc: "Bandra" },
  { first: "Karishma",  last: "Gajaria",        email: "kari.gajaria@gmail.com",             loc: "Bandra" },
  { first: "Khyati",    last: "Dand",           email: "khyatidand@gmail.com",               loc: "Bandra" },
  { first: "Krisna",    last: "Krishnankutty",  email: "kk@kripiq.com",                     loc: "Bandra" },
  { first: "Kyra",      last: "Bakshi",         email: "kshitij.bakshi@spit.ac.in",          loc: "Bandra" },
  { first: "Manpreet",  last: "Kaur",           email: "kaur.manpreet1592@gmail.com",        loc: "Bandra" },
  { first: "Pooja",     last: "Chen",           email: "gadk.pooja@gmail.com",               loc: "Bandra" },
  { first: "Pooja",     last: "Nair",           email: "nairpooja12@gmail.com",              loc: "Bandra" },
  { first: "Radhika",   last: "Nihalani Bajaj", email: "radhika.n92@gmail.com",              loc: "Bandra" },
  { first: "Shreya",    last: "Sharma",         email: "shreya.454@gmail.com",               loc: "Bandra" },
];

// ‚îÄ‚îÄ STICKER DEFINITIONS ‚îÄ‚îÄ
const STICKERS = [
  { emoji: 'üíô', label: 'Barre 57', abbr: 'B57', color: '#ff6b35' },
  { emoji: 'üö¥üèª‚Äç‚ôÄÔ∏è', label: 'powerCycle', abbr: 'PC', color: '#e63946' },
  { emoji: 'üßòüèª‚Äç‚ôÄÔ∏è', label: 'Mat 57', abbr: 'Mat', color: '#457b9d' },
  { emoji: 'ü´Ä', label: 'Cardio Barre', abbr: 'CB', color: '#f4a261' },
  { emoji: 'üèãÔ∏è', label: 'Strength Lab', abbr: 'LAB', color: '#6d6875' },
  { emoji: 'üîô', label: 'Back Body Blaze', abbr: 'BBB', color: '#2a9d8f' },
  { emoji: 'üî•', label: 'Amped Up', abbr: 'AMP', color: '#e9c46a' },
  { emoji: 'üí™üèª', label: 'FIT', abbr: 'FIT', color: '#264653' },
  { emoji: '‚ù§Ô∏è‚Äçüî•', label: 'HIIT', abbr: 'HIIT', color: '#d62828' },
  { emoji: '‚ù§Ô∏è‚Äçü©π', label: 'Recovery', abbr: 'REC', color: '#9b72cf' },
];
const STICKER_LABEL = Object.fromEntries(STICKERS.map(s => [s.abbr, { emoji: s.emoji, label: s.label }]));

// ‚îÄ‚îÄ WEEKLY REQUIREMENTS (Intermediate) ‚Äî Kemps Corner ‚îÄ‚îÄ
const WEEKLY_REQUIREMENTS_KC = {
  1: { 'CB': 3, 'PC': 1, 'Mat': 1 },
  2: { 'CB': 2, 'FIT': 1, 'BBB': 1, 'PC': 1 },
  3: { 'CB': 2, 'BBB': 1, 'FIT': 1, 'PC': 1 },
  4: { 'CB': 2, 'FIT': 1, 'PC': 1, 'LAB': 1 }
};
// ‚îÄ‚îÄ WEEKLY REQUIREMENTS (Intermediate) ‚Äî Bandra ‚îÄ‚îÄ
const WEEKLY_REQUIREMENTS_BANDRA = {
  1: { 'CB': 3, 'PC': 1, 'Mat': 1 },
  2: { 'CB': 2, 'FIT': 1, 'BBB': 1, 'PC': 1 },
  3: { 'CB': 2, 'BBB': 1, 'FIT': 1, 'PC': 1 },
  4: { 'CB': 1, 'BBB': 1, 'FIT': 2, 'PC': 2 }
};

// ‚îÄ‚îÄ DAY GENERATION ‚îÄ‚îÄ
const days = [];
const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const start = new Date(2026, 1, 23); // Feb 23 2026
for (let i = 0; i < 30; i++) {
  const d = new Date(start);
  d.setDate(start.getDate() + i);
  const dow = d.getDay();
  days.push({
    num: d.getDate(),
    mon: d.toLocaleString('default', { month: 'short' }),
    dayName: DAYS_SHORT[dow],
    isWeekend: dow === 0 || dow === 6,
    key: `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`,
    fullDate: d
  });
}

// Group into weeks
const weeks = [];
let wk = [];
days.forEach((d, i) => {
  wk.push({ ...d, dayIdx: i });
  if (d.isWeekend && d.dayName === 'Sun') { weeks.push(wk); wk = []; }
});
// Group Mon-Sun chunks of 7
const weekChunks = [];
for (let i = 0; i < days.length; i += 7) {
  weekChunks.push(days.slice(i, i + 7));
}
// Adjust: group by natural weeks (Mon-Sun or just every 7)
// Use a single subtle color for week accents to keep the UI consistent
const WEEK_COLORS = ['#1d4ed8','#1d4ed8','#1d4ed8','#1d4ed8','#1d4ed8'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
// state[memberIdx][dayKey] = stickerEmoji or null
const state = MEMBERS.map(() => ({}));

// ‚îÄ‚îÄ CELL TOOLTIP ‚îÄ‚îÄ
const cellTooltip = document.getElementById('cell-tooltip');
function showCellTooltip(text, anchorEl) {
  if (!text) return;
  cellTooltip.textContent = text;
  cellTooltip.style.display = 'block';
  const r = anchorEl.getBoundingClientRect();
  const tooltipHeight = cellTooltip.offsetHeight;
  cellTooltip.style.left = (r.left + r.width / 2) + 'px';
  let top = r.top - tooltipHeight - 8;
  if (top < 8) top = r.bottom + 8;
  cellTooltip.style.top = top + 'px';
}
function hideCellTooltip() {
  cellTooltip.style.display = 'none';
}

// ‚îÄ‚îÄ RENDER LEGEND ‚îÄ‚îÄ
function renderLegend() {
  const el = document.getElementById('legend-items');
  el.innerHTML = '';
  STICKERS.forEach(s => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<div class="sticker-preview">${s.emoji}</div>${s.label}`;
    el.appendChild(item);
  });
}

// ‚îÄ‚îÄ SCORE & SORT ‚îÄ‚îÄ
function getStickerAbbr(emoji) {
  const sticker = STICKERS.find(s => s.emoji === emoji);
  return sticker ? sticker.abbr : null;
}

// ‚îÄ‚îÄ CLASS EQUIVALENCY GROUPS ‚îÄ‚îÄ
const EQUIV_GROUPS = [
  new Set(['FIT', 'LAB']),
  new Set(['CB',  'BBB', 'CBP', 'HIIT', 'PC']),
];

function getEquivGroup(abbr) {
  return EQUIV_GROUPS.find(g => g.has(abbr)) || null;
}

function areWeeklyRequirementsMet(counts, requirements) {
  // Prevent double-counting by evaluating each equivalency group once.
  const handledGroups = new Set();

  for (const [classType, required] of Object.entries(requirements)) {
    const group = getEquivGroup(classType);

    // Non-equivalent class: strict exact count.
    if (!group) {
      if ((counts[classType] || 0) < required) return false;
      continue;
    }

    // Equivalent classes: compare grouped available vs grouped required exactly once.
    let groupId = '';
    group.forEach(a => { groupId += a + '|'; });
    if (handledGroups.has(groupId)) continue;
    handledGroups.add(groupId);

    let requiredInGroup = 0;
    Object.entries(requirements).forEach(([reqClass, reqCount]) => {
      if (group.has(reqClass)) requiredInGroup += reqCount;
    });

    let availableInGroup = 0;
    group.forEach(a => { availableInGroup += (counts[a] || 0); });

    if (availableInGroup < requiredInGroup) return false;
  }

  return true;
}

// Returns true if the given sticker abbr counts toward any requirement in weekNum for a given location
function isStickerQualifying(abbr, weekNum, loc) {
  const reqs = (loc === 'Bandra') ? WEEKLY_REQUIREMENTS_BANDRA : WEEKLY_REQUIREMENTS_KC;
  const requirements = reqs[weekNum];
  if (!requirements || !abbr) return false;
  return Object.keys(requirements).some(reqAbbr => {
    if (reqAbbr === abbr) return true;
    return EQUIV_GROUPS.some(g => g.has(reqAbbr) && g.has(abbr));
  });
}

function getWeekScore(mi, weekNum) {
  const weekIdx = weekNum - 1;
  const weekDays = weekChunks[weekIdx];
  if (!weekDays) return { completed: false, counts: {} };

  const loc = MEMBERS[mi] ? MEMBERS[mi].loc : 'KC';
  const reqs = (loc === 'Bandra') ? WEEKLY_REQUIREMENTS_BANDRA : WEEKLY_REQUIREMENTS_KC;
  const requirements = reqs[weekNum];
  if (!requirements) return { completed: false, counts: {} };

  // Count stickers for this week
  const counts = {};
  weekDays.forEach(day => {
    const emoji = state[mi][day.key];
    if (emoji) {
      const abbr = getStickerAbbr(emoji);
      if (abbr) {
        counts[abbr] = (counts[abbr] || 0) + 1;
      }
    }
  });

  // Week is complete only if all weekly goals are met without double-counting classes.
  const completed = areWeeklyRequirementsMet(counts, requirements);

  return { completed, counts, requirements };
}

function getScore(mi) {
  let score = 0;
  for (let week = 1; week <= 4; week++) {
    const { completed } = getWeekScore(mi, week);
    if (completed) score++;
  }
  return score;
}

function getStreak(mi) {
  let streak = 0;
  for (let i = days.length - 1; i >= 0; i--) {
    if (state[mi][days[i].key]) streak++;
    else break;
  }
  return streak;
}

function getTotalClasses(mi) {
  return days.reduce((sum, d) => sum + (state[mi][d.key] ? 1 : 0), 0);
}

function reqToStr(req) {
  return Object.entries(req).map(([cls, n]) => `${n}√ó${cls}`).join(' ¬∑ ');
}

function getRequirementLabel(abbr) {
  return STICKER_LABEL[abbr]?.label || abbr;
}

function buildWeekQualificationTooltip(mi, weekNum) {
  if (weekNum < 1 || weekNum > 4) return '';
  const { completed, counts, requirements } = getWeekScore(mi, weekNum);
  if (!requirements) return '';

  const lines = [
    `W${weekNum}: ${completed ? 'Qualified ‚úì' : 'Not qualified ‚úó'}`,
    'Reason:'
  ];

  const handledGroups = new Set();

  for (const [classType, required] of Object.entries(requirements)) {
    const group = getEquivGroup(classType);

    if (!group) {
      const done = counts[classType] || 0;
      lines.push(`‚Ä¢ ${classType}: ${done}/${required}`);
      continue;
    }

    const groupKey = Array.from(group).sort().join('|');
    if (handledGroups.has(groupKey)) continue;
    handledGroups.add(groupKey);

    let requiredInGroup = 0;
    const reqClasses = [];
    Object.entries(requirements).forEach(([reqClass, reqCount]) => {
      if (group.has(reqClass)) {
        requiredInGroup += reqCount;
        reqClasses.push(reqClass);
      }
    });

    let availableInGroup = 0;
    group.forEach(a => { availableInGroup += (counts[a] || 0); });

    const perClass = reqClasses.map(rc => `${rc}: ${counts[rc] || 0}`).join(', ');
    lines.push(`‚Ä¢ ${perClass} ‚Üí ${availableInGroup}/${requiredInGroup} combined`);
  }

  return lines.join('\n');
}

function buildSlotTooltip(abbr, label, mi, weekNum, loc) {
  if (!abbr || weekNum < 1 || weekNum > 4) return label;
  const { counts, requirements } = getWeekScore(mi, weekNum);
  if (!requirements) return label;
  const group = getEquivGroup(abbr);
  if (!group) {
    const req = requirements[abbr];
    if (req === undefined) return label;
    const done = counts[abbr] || 0;
    return `${label}\nW${weekNum} ¬∑ ${abbr}: ${done}/${req}${done >= req ? ' ‚úì' : ''}`;
  }
  const reqClasses = Object.keys(requirements).filter(r => group.has(r));
  if (reqClasses.length === 0) return label;
  const requiredInGroup = reqClasses.reduce((sum, rc) => sum + requirements[rc], 0);
  let availableInGroup = 0;
  group.forEach(a => { availableInGroup += (counts[a] || 0); });
  const perClass = reqClasses.map(rc => `${rc}: ${counts[rc] || 0}`).join(', ');
  return `${label}\nW${weekNum} ¬∑ ${perClass} ‚Üí ${availableInGroup}/${requiredInGroup} combined${availableInGroup >= requiredInGroup ? ' ‚úì' : ''}`;
}

// ‚îÄ‚îÄ STATE PERSISTENCE ‚îÄ‚îÄ
function saveStateToLocalStorage() {
  try {
    localStorage.setItem('sin30_intermediate_state', JSON.stringify(state));
  } catch (e) {
    console.warn('Failed to save state to localStorage:', e);
  }
}

function restoreStateFromLocalStorage() {
  try {
    const saved = localStorage.getItem('sin30_intermediate_state');
    if (saved) {
      const savedState = JSON.parse(saved);
      MEMBERS.forEach((m, mi) => {
        if (savedState[mi]) {
          Object.assign(state[mi], savedState[mi]);
        }
      });
      return true;
    }
  } catch (e) {
    console.warn('Failed to restore state from localStorage:', e);
  }
  return false;
}

// ‚îÄ‚îÄ COLLAPSE/EXPAND HELPERS ‚îÄ‚îÄ
function toggleLocationGroup(btn) {
  const tbody = document.getElementById('tbody');
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const header = btn.closest('tr.location-group-header');
  if (!header) return;
  
  // Find the index of this header
  let headerIndex = rows.indexOf(header);
  if (headerIndex === -1) return;
  
  // Toggle the button state
  btn.classList.toggle('collapsed');
  
  // Toggle all data-row rows until we hit the next location-group-header
  for (let i = headerIndex + 1; i < rows.length; i++) {
    const row = rows[i];
    if (row.classList.contains('location-group-header')) break;  // Stop at next location
    if (row.classList.contains('data-row')) {
      row.classList.toggle('hidden');
    }
  }
}

function getQualifiedMembersCount() {
  return MEMBERS.filter(m => getScore(MEMBERS.indexOf(m)) >= 1).length;
}

// ‚îÄ‚îÄ BUILD / REFRESH TABLE ‚îÄ‚îÄ
function refreshBoard() {
  // Update member count dynamically
  const countEl = document.getElementById('member-count-display');
  if (countEl) countEl.innerHTML = `${MEMBERS.length} <span>Members</span>`;

  // Update qualified count
  const qualifiedEl = document.getElementById('qualified-count-display');
  const qualifiedCount = getQualifiedMembersCount();
  if (qualifiedEl) qualifiedEl.textContent = `${qualifiedCount} Qualified`;

  // Group by location, sort by completed weeks desc, then total classes desc
  const allWithScores = MEMBERS.map((m, i) => ({ ...m, mi: i, score: getScore(i), streak: getStreak(i), total: getTotalClasses(i) }));
  const kcSorted     = allWithScores.filter(m => m.loc === 'KC').sort((a, b) => b.score - a.score || b.total - a.total || a.first.localeCompare(b.first));
  const bandraSorted = allWithScores.filter(m => m.loc === 'Bandra').sort((a, b) => b.score - a.score || b.total - a.total || a.first.localeCompare(b.first));

  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');

  // ‚îÄ‚îÄ THEAD ‚îÄ‚îÄ
  thead.innerHTML = '';

  // Week header row
  const weekRow = document.createElement('tr');
  weekRow.className = 'week-header-row';

  // Empty cells for rank and name columns
  const weekRankTh = document.createElement('th');
  weekRankTh.className = 'rank-h';
  weekRow.appendChild(weekRankTh);

  const weekNameTh = document.createElement('th');
  weekNameTh.className = 'name-h';
  weekRow.appendChild(weekNameTh);

  // Week headers spanning their days
  weekChunks.slice(0, 4).forEach((chunk, wi) => {
    const wColor = WEEK_COLORS[wi % WEEK_COLORS.length];
    const wFirst = chunk[0];
    const wLast = chunk[chunk.length - 1];
    const wDateStr = `${wFirst.mon} ${wFirst.num} ‚Äì ${wLast.mon} ${wLast.num}`;

    const weekTh = document.createElement('th');
    weekTh.className = 'week-h';
    weekTh.colSpan = chunk.length;
    let anyMemberCompletedWeek = false;
    for (let mi = 0; mi < MEMBERS.length; mi++) {
      const { completed } = getWeekScore(mi, wi + 1);
      if (completed) { anyMemberCompletedWeek = true; break; }
    }
    if (anyMemberCompletedWeek) weekTh.classList.add('week-goals-met');
    weekTh.innerHTML = `
      <div class="week-group-header">
        <div class="week-tag">Week ${wi + 1}</div>
        <div class="week-dates">${wDateStr}</div>
      </div>
    `;
    weekRow.appendChild(weekTh);
  });

  // Bonus days header (if there are more than 28 days)
  if (days.length > 28) {
    const bonusDays = days.slice(28);
    const bonusFirst = bonusDays[0];
    const bonusLast = bonusDays[bonusDays.length - 1];
    const bonusDateStr = `${bonusFirst.mon} ${bonusFirst.num} ‚Äì ${bonusLast.mon} ${bonusLast.num}`;

    const bonusTh = document.createElement('th');
    bonusTh.className = 'week-h bonus-week';
    bonusTh.colSpan = bonusDays.length;
    bonusTh.innerHTML = `
      <div class="week-group-header">
        <div class="week-tag">Bonus</div>
        <div class="week-dates">${bonusDateStr}</div>
      </div>
    `;
    weekRow.appendChild(bonusTh);
  }

  // Empty cell for score column
  const weekScoreTh = document.createElement('th');
  weekScoreTh.className = 'score-h';
  weekRow.appendChild(weekScoreTh);

  thead.appendChild(weekRow);

  // Day header row
  const headRow = document.createElement('tr');

  // Rank
  const rankTh = document.createElement('th');
  rankTh.className = 'rank-h';
  headRow.appendChild(rankTh);

  // Name
  const nameTh = document.createElement('th');
  nameTh.className = 'name-h';
  nameTh.innerHTML = `<span class="col-label">Member</span>`;
  headRow.appendChild(nameTh);

  // Days
  days.forEach((d, di) => {
    const th = document.createElement('th');
    th.className = 'day-h' + (d.isWeekend ? ' weekend' : '');
    th.innerHTML = `<span class="day-num">${d.num}</span><span class="day-name">${d.dayName}</span>`;

    // Add week separator border
    const weekIdx = Math.floor(di / 7);
    if (di > 0 && di % 7 === 0) {
      th.style.borderLeft = '2px solid var(--border-strong)';
    }

    headRow.appendChild(th);
  });

  // Score
  const scoreTh = document.createElement('th');
  scoreTh.className = 'score-h';
  scoreTh.innerHTML = `<span class="col-label">Weeks</span>`;
  headRow.appendChild(scoreTh);

  thead.appendChild(headRow);

  // ‚îÄ‚îÄ TBODY ‚îÄ‚îÄ
  tbody.innerHTML = '';

  function renderGroupRows(groupList, groupLabel, loc) {
    // Location separator row ‚Äî one td per week column for alignment
    const sepRow = document.createElement('tr');
    sepRow.className = 'location-group-header';

    // Label spans rank + name columns
    const labelTd = document.createElement('td');
    labelTd.colSpan = 2;
    labelTd.className = 'location-header-cell location-label-cell';
    
    const btn = document.createElement('button');
    btn.className = 'location-toggle-btn';
    btn.type = 'button';
    btn.innerHTML = `<span class="location-toggle-icon">‚ñº</span><span>${groupLabel}</span>`;
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleLocationGroup(btn);
    });
    
    labelTd.appendChild(btn);
    sepRow.appendChild(labelTd);

    const locReqs = (loc === 'Bandra') ? WEEKLY_REQUIREMENTS_BANDRA : WEEKLY_REQUIREMENTS_KC;

    // One td per week chunk (W1‚ÄìW4), aligned to the day columns
    weekChunks.slice(0, 4).forEach((chunk, wi) => {
      const goalTd = document.createElement('td');
      goalTd.colSpan = chunk.length;
      goalTd.className = 'location-header-cell location-goal-cell';
      const wn = wi + 1;
      const pills = Object.entries(locReqs[wn]).map(([cls, n]) => {
        const info = STICKER_LABEL[cls] || { emoji: '', label: cls };
        return `<span class="loc-req-pill"><em class="loc-req-count">${n}√ó</em><span class="loc-req-icon">${info.emoji}</span><span class="loc-req-name">${info.label}</span></span>`;
      }).join('');
      goalTd.innerHTML = `<div class="loc-goal-wrap"><span class="loc-span-arrow loc-arrow-l">‚Äπ</span><button class="loc-goal-badge" onclick="this.classList.toggle('open')"><span class="loc-badge-label">Goals</span><div class="loc-badge-detail">${pills}</div></button><span class="loc-span-arrow loc-arrow-r">‚Ä∫</span></div>`;
      sepRow.appendChild(goalTd);
    });

    // Bonus days td (if applicable)
    if (days.length > 28) {
      const bonusTd = document.createElement('td');
      bonusTd.colSpan = days.length - 28;
      bonusTd.className = 'location-header-cell';
      sepRow.appendChild(bonusTd);
    }

    // Score column td
    const scoreTd = document.createElement('td');
    scoreTd.className = 'location-header-cell';
    sepRow.appendChild(scoreTd);

    tbody.appendChild(sepRow);

    groupList.forEach((m, rank) => {
      const animDelay = rank * 0.04;
      const row = document.createElement('tr');
      row.className = 'data-row';
      row.style.animationDelay = animDelay + 's';

      // Rank cell
      const rankTd = document.createElement('td');
      rankTd.className = 'rank-td';
      const rankClass = '';
      const rankDisplay = rank + 1;
      rankTd.innerHTML = `<div class="rank-inner ${rankClass}">${rankDisplay}</div>`;
      row.appendChild(rankTd);

      // Name cell
      const nameTd = document.createElement('td');
      nameTd.className = 'name-td';
      const streakHtml = m.streak >= 3
        ? `<span class="streak-flame show">üî• ${m.streak}</span>`
        : `<span class="streak-flame"></span>`;
      nameTd.innerHTML = `
        <div class="member-name">${m.first} ${m.last}</div>
        <div class="member-sub">${streakHtml}</div>
      `;
      row.appendChild(nameTd);

      // Day cells
      days.forEach((d, di) => {
        const td = document.createElement('td');

        // Determine which week this day belongs to (1-4)
        const weekNum = Math.floor(di / 7) + 1;
        const isCompletedWeek = weekNum <= 4 && getWeekScore(m.mi, weekNum).completed;
        const weekTooltipText = weekNum <= 4 ? buildWeekQualificationTooltip(m.mi, weekNum) : '';

        td.className = 'day-td' + (d.isWeekend ? ' weekend' : '') + (isCompletedWeek ? ' week-completed' : '');

        if (weekTooltipText) {
          td.addEventListener('mouseenter', () => showCellTooltip(weekTooltipText, td));
          td.addEventListener('mouseleave', hideCellTooltip);
        }

        // Add week separator border
        if (di > 0 && di % 7 === 0) {
          td.style.borderLeft = '2px solid var(--border-strong)';
        }

        const stickerVal  = state[m.mi][d.key];
        const stickerAbbr  = stickerVal ? getStickerAbbr(stickerVal) : null;
        const stickerLabel = stickerVal ? (STICKERS.find(s => s.emoji === stickerVal)?.label || '') : '';
        // Only mark a sticker as "qualifying" if it both matches a required class and the
        // member has actually completed that week (so partial progress doesn't show as fully qualified)
        const qualifying   = !!stickerAbbr && weekNum >= 1 && weekNum <= 4 && isStickerQualifying(stickerAbbr, weekNum, m.loc) && isCompletedWeek;
        const slot = document.createElement('div');
        slot.className = 'sticker-slot' + (stickerVal ? ' has-sticker' : '') + (qualifying ? ' qualifying' : '');
        slot.textContent = stickerVal || '';
        slot.dataset.mi = m.mi;
        slot.dataset.dk = d.key;
        if (stickerLabel) slot.dataset.label = stickerLabel;

        slot.addEventListener('mouseenter', () => {
          if (stickerAbbr && weekNum <= 4) {
            showCellTooltip(buildSlotTooltip(stickerAbbr, stickerLabel, m.mi, weekNum, m.loc), slot);
          } else if (stickerLabel) {
            showCellTooltip(stickerLabel, slot);
          }
        });
        slot.addEventListener('mouseleave', () => {
          if (weekTooltipText) showCellTooltip(weekTooltipText, td);
          else hideCellTooltip();
        });

        td.appendChild(slot);
        row.appendChild(td);
      });

      // Score cell
      const scoreTd = document.createElement('td');
      scoreTd.className = 'score-td';
      const sc = m.score;
      const pillClass = sc === 0 ? '' : sc >= 4 ? ' maxed' : ' lit';

      // Build weekly status for tooltip
      let tooltipHTML = '<div class="weekly-status">';
      for (let week = 1; week <= 4; week++) {
        const { completed } = getWeekScore(m.mi, week);
        const badgeClass = completed ? ' complete' : '';
        const icon = completed ? '‚úì' : '‚óã';
        tooltipHTML += `<div class="week-badge${badgeClass}">W${week} ${icon}</div>`;
      }
      tooltipHTML += '</div>';

      scoreTd.innerHTML = `
        <div class="score-pill${pillClass}">
          ${sc}/4
          <div class="score-tooltip">${tooltipHTML}</div>
        </div>
      `;
      row.appendChild(scoreTd);

      tbody.appendChild(row);
    });
  }

  renderGroupRows(kcSorted, 'üìç  Kemps Corner', 'KC');
  renderGroupRows(bandraSorted, 'üìç  Supreme HQ, Bandra', 'Bandra');
}

// ‚îÄ‚îÄ GOOGLE SHEETS CONFIG ‚îÄ‚îÄ
// Configuration loaded from external config.live.js file
const GSHEET_SPREADSHEET_ID = window.GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID;
const GSHEET_SHEET_NAME     = window.GOOGLE_SHEETS_CONFIG.SHEET_NAME;
const OAUTH_CLIENT_ID       = window.GOOGLE_SHEETS_CONFIG.CLIENT_ID;
const OAUTH_CLIENT_SECRET   = window.GOOGLE_SHEETS_CONFIG.CLIENT_SECRET;
const OAUTH_REFRESH_TOKEN   = window.GOOGLE_SHEETS_CONFIG.REFRESH_TOKEN;

const CHALLENGE_START = new Date(2026, 1, 23);

function cleanedClassToEmoji(cleanedClass) {
  const c = (cleanedClass || '').toLowerCase();
  if (/barre 57|studio barre/.test(c))           return '\u{1F499}';
  if (/powercycle|power cycle|cycle/.test(c))    return '\u{1F6B4}\u{1F3FB}\u{200D}\u{2640}\u{FE0F}';
  if (/mat 57|mat57/.test(c))                    return '\u{1F9D8}\u{1F3FB}\u{200D}\u{2640}\u{FE0F}';
  if (/cardio barre/.test(c))                    return '\u{1FAC0}';
  if (/strength lab|studio lab/.test(c))         return '\u{1F3CB}\u{FE0F}';
  if (/back body blaze/.test(c))                 return '\u{1F519}';
  if (/amped up/.test(c))                        return '\u{1F525}';
  if (/\bfit\b/.test(c))                         return '\u{1F4AA}\u{1F3FB}';
  if (/hiit/.test(c))                            return '\u{2764}\u{FE0F}\u{200D}\u{1F525}';
  if (/recovery/.test(c))                        return '\u{2764}\u{FE0F}\u{200D}\u{1FA79}';
  return null;
}

function normalizeName(s) {
  return (s || '').trim().toLowerCase().replace(/\s+/g, ' ');
}

async function getAccessToken() {
  // Check if credentials are properly configured
  const cfg = window.GOOGLE_SHEETS_CONFIG;
  if (!cfg.CLIENT_ID || cfg.CLIENT_ID === 'YOUR_CLIENT_ID_HERE' ||
      !cfg.CLIENT_SECRET || cfg.CLIENT_SECRET === 'YOUR_CLIENT_SECRET_HERE' ||
      !cfg.REFRESH_TOKEN || cfg.REFRESH_TOKEN === 'YOUR_REFRESH_TOKEN_HERE') {
    throw new Error('Google Sheets integration not configured. Please update GOOGLE_SHEETS_CONFIG with your credentials.');
  }

  const resp = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id:     cfg.CLIENT_ID,
      client_secret: cfg.CLIENT_SECRET,
      refresh_token: cfg.REFRESH_TOKEN,
      grant_type:    'refresh_token',
    })
  });
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error('Token refresh failed: ' + (err.error_description || resp.status));
  }
  const data = await resp.json();
  return data.access_token;
}

async function fetchSheetRows(accessToken) {
  const cfg   = window.GOOGLE_SHEETS_CONFIG;
  const range = encodeURIComponent(cfg.SHEET_NAME + '!A:Z');
  const url   = `https://sheets.googleapis.com/v4/spreadsheets/${cfg.SPREADSHEET_ID}/values/${range}`;
  const resp  = await fetch(url, { headers: { Authorization: 'Bearer ' + accessToken } });
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error('Sheets fetch failed: ' + ((err.error && err.error.message) || resp.status));
  }
  const data = await resp.json();
  return data.values || [];
}

async function fetchAndSeedCheckins() {
  const statusEl = document.getElementById('data-status');
  const btn      = document.getElementById('refresh-btn');
  if (statusEl) statusEl.textContent = '';
  if (btn)      btn.disabled = true;
  const loader = document.getElementById('board-loader');
  if (loader) loader.classList.remove('hidden');

  try {
    const accessToken = await getAccessToken();
    const rows        = await fetchSheetRows(accessToken);

    if (rows.length < 2) {
      if (statusEl) statusEl.textContent = 'No data found in sheet.';
      return;
    }

    const headers    = rows[0].map(h => h.trim());
    const col        = name => headers.indexOf(name);
    const iFirst     = col('First Name');
    const iLast      = col('Last Name');
    const iEmail     = col('Email');
    const iCheckedIn = col('Checked In');
    const iDate      = col('Date (IST)');
    const iClass     = col('Cleaned Class');

    MEMBERS.forEach((_, mi) => {
      Object.keys(state[mi]).forEach(k => delete state[mi][k]);
    });

    let matched = 0;

    rows.slice(1).forEach(row => {
      if ((row[iCheckedIn] || '').trim().toUpperCase() !== 'TRUE') return;
      const dateStr = (row[iDate] || '').trim();
      const rowDate = new Date(dateStr + 'T00:00:00');
      if (isNaN(rowDate.getTime()) || rowDate < CHALLENGE_START) return;
      const emoji = cleanedClassToEmoji((row[iClass] || '').trim());
      if (!emoji) return;
      const rowEmail = (row[iEmail] || '').trim().toLowerCase();
      let mi = MEMBERS.findIndex(m => m.email && m.email.toLowerCase() === rowEmail);
      // Fallback: match by first + last name if email has no match
      if (mi === -1) {
        const rowFirst = (row[iFirst] || '').trim().toLowerCase();
        const rowLast  = (row[iLast]  || '').trim().toLowerCase();
        if (rowFirst && rowLast) {
          mi = MEMBERS.findIndex(m =>
            m.first.toLowerCase() === rowFirst &&
            m.last.toLowerCase()  === rowLast
          );
        }
      }
      if (mi === -1) return;
      const dk = `${rowDate.getFullYear()}-${rowDate.getMonth()}-${rowDate.getDate()}`;
      if (!days.find(d => d.key === dk)) return;
      if (!state[mi][dk]) { state[mi][dk] = emoji; matched++; }
    });

    refreshBoard();
    saveStateToLocalStorage();
    const now     = new Date();
    const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    if (statusEl) statusEl.textContent = '';
  } catch (err) {
    console.error(err);
    if (statusEl) {
      if (err.message.includes('not configured') || err.message.includes('not found')) {
        statusEl.textContent = '‚ö† Google Sheets not configured ¬∑ Please set up credentials';
      } else {
        statusEl.textContent = '‚úó ' + err.message;
      }
    }
  } finally {
    if (btn) btn.disabled = false;
    const loader = document.getElementById('board-loader');
    if (loader) loader.classList.add('hidden');
  }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
if (restoreStateFromLocalStorage()) {
  renderLegend();
  refreshBoard();
}
const loader = document.getElementById('board-loader');
if (loader) loader.classList.add('hidden');
renderLegend();
refreshBoard();
fetchAndSeedCheckins();
</script>
</body>
</html>
